const functions = require('firebase-functions');
const admin = require('firebase-admin');
const axios = require('axios');
const cheerio = require('cheerio');
const { Session, cloudApi, serviceClients } = require('@yandex-cloud/nodejs-sdk');
const { TextGenerationServiceClient } = require('@yandex-cloud/nodejs-sdk/dist/generated/yandex/cloud/ai/llm/v1alpha/llm_service');

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
admin.initializeApp();
const db = admin.firestore();

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
function getDatabase() {
    return admin.firestore();
}

// YandexGPT –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–∏–∑ env –∏–ª–∏ functions config)
function getYandexConfig() {
    try {
        const cfg = require('./config');
        const apiKey = process.env.YANDEX_API_KEY || cfg.yandex.api_key;
        const folderId = process.env.YANDEX_FOLDER_ID || cfg.yandex.folder_id;
        const model = process.env.YANDEX_MODEL || cfg.yandex.model;

        if (!apiKey || !folderId || apiKey === 'your_yandex_api_key_here') {
            console.log('‚ö†Ô∏è YandexGPT –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö.');
            return null;
        }

        return { apiKey, folderId, model };
    } catch (error) {
        console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ YandexGPT:', error.message);
        return null;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å YandexGPT —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç
async function parseTelegramMessageWithSDK(messageText, messageLink = '') {
    const prompt = `
–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É —Å–æ–æ–±—â–µ–Ω–∏–π –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö –≤ Telegram –∫–∞–Ω–∞–ª–∞—Ö. 

–ó–ê–î–ê–ß–ê: –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –∏–∑–≤–ª–µ–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏.

–°–û–û–ë–©–ï–ù–ò–ï:
"${messageText}"

–°–°–´–õ–ö–ê: ${messageLink}

–ü–†–ê–í–ò–õ–ê –ê–ù–ê–õ–ò–ó–ê:
1. –ò—â–∏ –¢–û–õ–¨–ö–û –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è —Å –¥–∞—Ç–æ–π, –≤—Ä–µ–º–µ–Ω–µ–º –∏ –º–µ—Å—Ç–æ–º
2. –ò–≥–Ω–æ—Ä–∏—Ä—É–π –æ–±—â–∏–µ –Ω–æ–≤–æ—Å—Ç–∏, –∞–Ω–æ–Ω—Å—ã, —Ä–µ–∫–ª–∞–º—É, —Å–ø–∞–º
3. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ - –≤–µ—Ä–Ω–∏ null
4. –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –¥–∞–Ω–Ω—ã–µ - –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –µ—Å—Ç—å –≤ —Ç–µ–∫—Å—Ç–µ
5. –ë—É–¥—å —Å—Ç—Ä–æ–≥–∏–º –∫ –∫–∞—á–µ—Å—Ç–≤—É –¥–∞–Ω–Ω—ã—Ö

–ß–¢–û –ò–°–ö–ê–¢–¨:
- –ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è (–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ, –Ω–µ –æ–±—â–µ–µ)
- –î–∞—Ç—É –∏ –≤—Ä–µ–º—è (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ, –Ω–µ "—Å–∫–æ—Ä–æ" –∏–ª–∏ "–≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ")
- –ú–µ—Å—Ç–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∞–¥—Ä–µ—Å –∏–ª–∏ –ª–æ–∫–∞—Ü–∏—é)
- –¶–µ–Ω—É (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞) –∏–ª–∏ "–±–µ—Å–ø–ª–∞—Ç–Ω–æ"
- –¢–∏–ø –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è (–∫–æ–Ω—Ü–µ—Ä—Ç, –≤—ã—Å—Ç–∞–≤–∫–∞, –ª–µ–∫—Ü–∏—è –∏ —Ç.–¥.)

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (—Å—Ç—Ä–æ–≥–æ JSON):
{
    "title": "–¢–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞",
    "description": "–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–¥–æ 200 —Å–∏–º–≤–æ–ª–æ–≤)",
    "date": "2024-09-15 19:00",
    "location": "–ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –º–µ—Å—Ç–æ –∏–∑ —Ç–µ–∫—Å—Ç–∞",
    "price": "500 —Ä—É–±–ª–µ–π" –∏–ª–∏ "–±–µ—Å–ø–ª–∞—Ç–Ω–æ" –∏–ª–∏ null,
    "categories": ["–º—É–∑—ã–∫–∞", "–∫–æ–Ω—Ü–µ—Ä—Ç"],
    "confidence": 0.9,
    "isOnline": false,
    "isFree": false
}

–ï—Å–ª–∏ —ç—Ç–æ –ù–ï –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –∏–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ - –≤–µ—Ä–Ω–∏ null.
`;

    try {
        const config = getYandexConfig();
        
        if (!config) {
            console.log('‚ùå YandexGPT –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ü–∞—Ä—Å–∏–Ω–≥ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω.');
            return null;
        }
        
        const { folderId, model } = config;
        
        console.log('ü§ñ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –≤ YandexGPT —á–µ—Ä–µ–∑ HTTP API (–æ–±–Ω–æ–≤–ª–µ–Ω–æ v5)...');
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º HTTP API —Å API –∫–ª—é—á–æ–º –Ω–∞–ø—Ä—è–º—É—é
        const response = await axios.post(
            'https://llm.api.cloud.yandex.net/foundationModels/v1/completion',
            {
                modelUri: `gpt://${folderId}/${model}`,
                completionOptions: {
                    stream: false,
                    temperature: 0.1,
                    maxTokens: 1500
                },
                messages: [
                    {
                        role: 'user',
                        text: prompt
                    }
                ]
            },
            {
                headers: {
                    'Authorization': `Api-Key AQVNxiHkCODl9-BAnpVhQRW61w5b8APj3bDVE-82`,
                    'Content-Type': 'application/json'
                }
            }
        );

        const result = response.data.result.alternatives[0].message.text;
        console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç YandexGPT:', result);
        
        try {
            // –£–±–∏—Ä–∞–µ–º markdown –±–ª–æ–∫–∏ ``` –µ—Å–ª–∏ –µ—Å—Ç—å
            let jsonText = result.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç null
            if (jsonText === 'null' || jsonText === '') {
                console.log('‚ö†Ô∏è YandexGPT –≤–µ—Ä–Ω—É–ª null - —ç—Ç–æ –Ω–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ');
                return null;
            }
            
            // –ü–∞—Ä—Å–∏–º JSON –æ—Ç–≤–µ—Ç
            const parsedData = JSON.parse(jsonText);
            
            // –ï—Å–ª–∏ —ç—Ç–æ –º–∞—Å—Å–∏–≤ —Å–æ–±—ã—Ç–∏–π, –±–µ—Ä–µ–º –ø–µ—Ä–≤–æ–µ —Å –≤—ã—Å–æ–∫–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å—é
            let parsedEvent;
            if (Array.isArray(parsedData)) {
                parsedEvent = parsedData.find(event => event.confidence > 0.7);
                if (!parsedEvent) {
                    console.log('‚ö†Ô∏è –ù–∏–∑–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ:', parsedData[0]?.confidence);
                    return null;
                }
            } else {
                parsedEvent = parsedData;
            }
            
            if (parsedEvent && parsedEvent.confidence > 0.7) {
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞—Ç—É –≤ timestamp
                const dateStr = parsedEvent.date;
                let startAtMillis = new Date(dateStr).getTime();
                
                // –ï—Å–ª–∏ –¥–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ "—Å X –ø–æ Y", –±–µ—Ä–µ–º –ø–µ—Ä–≤—É—é –¥–∞—Ç—É
                if (isNaN(startAtMillis) && dateStr.includes('—Å ') && dateStr.includes(' –ø–æ ')) {
                    const firstDate = dateStr.split('—Å ')[1]?.split(' –ø–æ ')[0];
                    if (firstDate) {
                        startAtMillis = new Date(firstDate.trim()).getTime();
                    }
                }
                
                // –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ NaN, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è + 1 –¥–µ–Ω—å
                if (isNaN(startAtMillis)) {
                    startAtMillis = Date.now() + 24 * 60 * 60 * 1000;
                }
                
                return {
                    title: parsedEvent.title,
                    description: parsedEvent.description || '',
                    startAtMillis: startAtMillis,
                    isOnline: parsedEvent.isOnline || false,
                    isFree: parsedEvent.isFree || false,
                    price: parsedEvent.price,
                    location: parsedEvent.location,
                    imageUrls: [],
                    categories: parsedEvent.categories || [],
                    confidence: parsedEvent.confidence
                };
            } else {
                console.log('‚ö†Ô∏è –ù–∏–∑–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ:', parsedEvent.confidence);
                return null;
            }
        } catch (parseError) {
            console.log('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –æ—Ç–≤–µ—Ç–∞:', parseError.message);
            return null;
        }
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –≤ parseTelegramMessageWithSDK:', error);
        return null;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è IAM-—Ç–æ–∫–µ–Ω–∞ —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
async function getIamToken() {
    try {
        console.log('ü§ñ –ü–æ–ª—É—á–∞–µ–º IAM-—Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ Yandex Cloud API...');
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º API –∫–ª—é—á –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è IAM-—Ç–æ–∫–µ–Ω–∞
        const response = await axios.post(
            'https://iam.api.cloud.yandex.net/iam/v1/tokens',
            {
                yandexPassportOauthToken: 'AQVNw_xujlX2tui5in5a-nZ0sTq3wAF_s8xZuEww'
            },
            {
                headers: {
                    'Content-Type': 'application/json'
                }
            }
        );
        
        console.log('‚úÖ IAM-—Ç–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω —É—Å–ø–µ—à–Ω–æ');
        return response.data.iamToken;
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è IAM-—Ç–æ–∫–µ–Ω–∞:', error.response?.data || error.message);
        return null;
    }
}

// Telegram Bot API –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
function getTelegramConfig() {
    try {
        const cfg = require('./config');
        const botToken = process.env.TELEGRAM_BOT_TOKEN || cfg.telegram?.bot_token;
        
        if (!botToken || botToken === 'your_telegram_bot_token_here') {
            console.log('‚ö†Ô∏è Telegram Bot Token –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–µ–±-—Å–∫—Ä–∞–ø–ø–∏–Ω–≥.');
            return null;
        }
        
        return { botToken };
    } catch (error) {
        console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Telegram:', error.message);
        return null;
    }
}

// –£–¥–∞–ª–µ–Ω RSS –ø–∞—Ä—Å–µ—Ä - –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–µ–±-—Å–∫—Ä–∞–ø–ø–∏–Ω–≥

// –°–ø–∏—Å–æ–∫ –ø—É–±–ª–∏—á–Ω—ã—Ö Telegram –∫–∞–Ω–∞–ª–æ–≤ –¥–ª—è –≤–µ–±-—Å–∫—Ä–∞–ø–ø–∏–Ω–≥–∞
const TELEGRAM_CHANNELS = [
    {
        name: '–ù–∞ –§–∞–Ω–µ—Ä–µ',
        username: 'Na_Fanere',
        url: 'https://t.me/s/Na_Fanere',
        category: 'events'
    },
    {
        name: '–ì–∞–∑–µ—Ç–∞ –ó–∞–≤—Ç—Ä–∞ –ú–æ—Å–∫–≤–∞',
        username: 'gzsmsk',
        url: 'https://t.me/s/gzsmsk',
        category: 'news'
    },
    {
        name: '–ú–æ—Å–∫–æ–≤—Å–∫–∏–π –≥—É–ª—è–∫–∞',
        username: 'mosgul',
        url: 'https://t.me/s/mosgul',
        category: 'events'
    },
    {
        name: '–§—Ä–∏—Å–∫–∏–¥–æ—Å',
        username: 'freeskidos',
        url: 'https://t.me/s/freeskidos',
        category: 'events'
    },
    {
        name: '–ù–æ—è–±—Ä—å –∫–∏–Ω–æ',
        username: 'novembercinema',
        url: 'https://t.me/s/novembercinema',
        category: 'cinema'
    },
    {
        name: '–ù–æ–≤–æ—Å—Ç–∏ –ú–æ—Å–∫–≤—ã',
        username: 'NovostiMoskvbl',
        url: 'https://t.me/s/NovostiMoskvbl',
        category: 'news'
    },
    {
        name: '–¢–æ–ª—å–∫–æ –ø–∞—Ä–∫',
        username: 'only_park',
        url: 'https://t.me/s/only_park',
        category: 'events'
    },
    {
        name: '–ü—Ä–æ—Å—Ç–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞',
        username: 'prostpolitika',
        url: 'https://t.me/s/prostpolitika',
        category: 'politics'
    },
    {
        name: '–¶–∏—Ñ–µ—Ä–±–ª–∞—Ç –ú–æ—Å–∫–≤–∞',
        username: 'ziferblatmost',
        url: 'https://t.me/s/ziferblatmost',
        category: 'events'
    }
];


// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–∞–Ω–∞–ª–æ–≤ –∏–∑ Firestore
async function getMonitoredChannels() {
    try {
        const channelsDoc = await admin.firestore().collection('config').doc('telegram_channels').get();
        if (channelsDoc.exists) {
            return channelsDoc.data().channels || [];
        }
        return [];
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–∞–Ω–∞–ª–æ–≤:', error);
        return [];
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞ –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
async function addChannelToMonitoring(username, name) {
    try {
        const channelsRef = admin.firestore().collection('config').doc('telegram_channels');
        await channelsRef.set({
            channels: admin.firestore.FieldValue.arrayUnion({
                username: username,
                name: name,
                addedAt: admin.firestore.FieldValue.serverTimestamp()
            })
        }, { merge: true });
        
        return { success: true };
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞:', error);
        return { success: false, error: error.message };
    }
}

// –ö—ç—à –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π (–≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
const processedMessages = new Set();

// –§—É–Ω–∫—Ü–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
async function parseTelegramMessage(messageText, messageLink = '') {
    console.log('ü§ñ –ü–∞—Ä—Å–∏–Ω–≥ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ YandexGPT...');
    try {
        const result = await parseTelegramMessageWithSDK(messageText, messageLink);
        console.log('‚úÖ YandexGPT —Ä–µ–∑—É–ª—å—Ç–∞—Ç:', result);
        return result;
    } catch (error) {
        console.log('‚ùå –û—à–∏–±–∫–∞ YandexGPT:', error.message);
        return null;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ Telegram –∫–∞–Ω–∞–ª–æ–≤ —á–µ—Ä–µ–∑ Bot API
async function parseTelegramChannelWithBotAPI(channelUsername, limit = 20) {
    const telegramConfig = getTelegramConfig();
    
    if (!telegramConfig) {
        console.log('‚ö†Ô∏è Telegram Bot API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–µ–±-—Å–∫—Ä–∞–ø–ø–∏–Ω–≥');
        return await scrapeChannelMessages(`https://t.me/s/${channelUsername}`, limit);
    }
    
    try {
        console.log(`ü§ñ –ü–∞—Ä—Å–∏–Ω–≥ –∫–∞–Ω–∞–ª–∞ @${channelUsername} —á–µ—Ä–µ–∑ Bot API...`);
        
        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–Ω–∞–ª–µ
        const channelInfo = await axios.get(`https://api.telegram.org/bot${telegramConfig.botToken}/getChat`, {
            params: { chat_id: `@${channelUsername}` }
        });
        
        if (!channelInfo.data.ok) {
            console.log(`‚ùå –ö–∞–Ω–∞–ª @${channelUsername} –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ Bot API`);
            return await scrapeChannelMessages(`https://t.me/s/${channelUsername}`, limit);
        }
        
        console.log(`‚úÖ –ö–∞–Ω–∞–ª –Ω–∞–π–¥–µ–Ω: ${channelInfo.data.result.title}`);
        
        // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        const messages = await axios.get(`https://api.telegram.org/bot${telegramConfig.botToken}/getUpdates`, {
            params: {
                offset: -limit,
                limit: limit,
                timeout: 30
            }
        });
        
        if (!messages.data.ok || !messages.data.result.length) {
            console.log(`‚ö†Ô∏è –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –∫–∞–Ω–∞–ª–∞ @${channelUsername} —á–µ—Ä–µ–∑ Bot API`);
            return await scrapeChannelMessages(`https://t.me/s/${channelUsername}`, limit);
        }
        
        const channelMessages = messages.data.result
            .filter(update => update.channel_post && update.channel_post.chat.username === channelUsername)
            .map(update => ({
                messageId: update.channel_post.message_id,
                text: update.channel_post.text || update.channel_post.caption || '',
                date: new Date(update.channel_post.date * 1000).toISOString(),
                link: `https://t.me/${channelUsername}/${update.channel_post.message_id}`,
                messageDate: new Date(update.channel_post.date * 1000).toISOString()
            }))
            .slice(0, limit);
        
        console.log(`‚úÖ –ü–æ–ª—É—á–µ–Ω–æ ${channelMessages.length} —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ Bot API`);
        return channelMessages;
        
    } catch (error) {
        console.error(`‚ùå –û—à–∏–±–∫–∞ Bot API –¥–ª—è @${channelUsername}:`, error.message);
        console.log('üîÑ Fallback –Ω–∞ –≤–µ–±-—Å–∫—Ä–∞–ø–ø–∏–Ω–≥');
        return await scrapeChannelMessages(`https://t.me/s/${channelUsername}`, limit);
    }
}

// –ü—Ä–æ—Å—Ç–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏ –±–µ–∑ YandexGPT
function extractEventDataSimple(messageText, messageLink) {
    console.log('–ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Å—Ç—ã–º —Å–ø–æ—Å–æ–±–æ–º...');
    
    const text = messageText.toLowerCase();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ
    const eventKeywords = [
        '–∫–æ–Ω—Ü–µ—Ä—Ç', '–≤—ã—Å—Ç–∞–≤–∫–∞', '–ª–µ–∫—Ü–∏—è', '–º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å', '—Ñ–µ—Å—Ç–∏–≤–∞–ª—å', '–∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è', 
        '—Å–µ–º–∏–Ω–∞—Ä', '–≤—Å—Ç—Ä–µ—á–∞', '–ø–æ–∫–∞–∑', '–ø—Ä–µ–º—å–µ—Ä–∞', '—Å–ø–µ–∫—Ç–∞–∫–ª—å', '–ø–µ—Ä—Ñ–æ—Ä–º–∞–Ω—Å'
    ];
    
    const hasEventKeyword = eventKeywords.some(keyword => text.includes(keyword));
    if (!hasEventKeyword) {
        console.log('‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏');
        return null;
    }
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞—Ç—É
    const datePatterns = [
        /(\d{1,2})\s*(—è–Ω–≤–∞—Ä—è|—Ñ–µ–≤—Ä–∞–ª—è|–º–∞—Ä—Ç–∞|–∞–ø—Ä–µ–ª—è|–º–∞—è|–∏—é–Ω—è|–∏—é–ª—è|–∞–≤–≥—É—Å—Ç–∞|—Å–µ–Ω—Ç—è–±—Ä—è|–æ–∫—Ç—è–±—Ä—è|–Ω–æ—è–±—Ä—è|–¥–µ–∫–∞–±—Ä—è)/i,
        /(\d{1,2}):(\d{2})/,
        /(–∑–∞–≤—Ç—Ä–∞|—Å–µ–≥–æ–¥–Ω—è|–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫|–≤—Ç–æ—Ä–Ω–∏–∫|—Å—Ä–µ–¥–∞|—á–µ—Ç–≤–µ—Ä–≥|–ø—è—Ç–Ω–∏—Ü–∞|—Å—É–±–±–æ—Ç–∞|–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ)/i
    ];
    
    let hasDate = false;
    for (const pattern of datePatterns) {
        if (pattern.test(messageText)) {
            hasDate = true;
            break;
        }
    }
    
    if (!hasDate) {
        console.log('‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–∞—Ç–∞/–≤—Ä–µ–º—è');
        return null;
    }
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –º–µ—Å—Ç–æ
    const locationPatterns = [
        /(?:–º–µ—Å—Ç–æ|–∞–¥—Ä–µ—Å|–≥–¥–µ)[:\s]*([^.\n]+)/i,
        /(?:–≤|–Ω–∞)\s+([–ê-–Ø–∞-—è\s\d,.-]+)/i
    ];
    
    let location = '–ú–æ—Å–∫–≤–∞'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
    for (const pattern of locationPatterns) {
        const match = messageText.match(pattern);
        if (match && match[1]) {
            location = match[1].trim();
            break;
        }
    }
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ü–µ–Ω—É
    const pricePatterns = [
        /(\d+)\s*—Ä—É–±/i,
        /–±–µ—Å–ø–ª–∞—Ç–Ω–æ/i,
        /–≤—Ö–æ–¥\s*—Å–≤–æ–±–æ–¥–Ω—ã–π/i
    ];
    
    let price = null;
    let isFree = false;
    for (const pattern of pricePatterns) {
        const match = messageText.match(pattern);
        if (match) {
            if (match[0].toLowerCase().includes('–±–µ—Å–ø–ª–∞—Ç–Ω–æ') || match[0].toLowerCase().includes('—Å–≤–æ–±–æ–¥–Ω—ã–π')) {
                isFree = true;
            } else {
                price = match[0];
            }
            break;
        }
    }
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ (–ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫)
    const lines = messageText.split('\n').filter(line => line.trim().length > 0);
    const title = lines[0].substring(0, 100); // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ 100 —Å–∏–º–≤–æ–ª–æ–≤
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    const categories = [];
    if (text.includes('–∫–æ–Ω—Ü–µ—Ä—Ç') || text.includes('–º—É–∑—ã–∫–∞')) categories.push('–º—É–∑—ã–∫–∞');
    if (text.includes('–≤—ã—Å—Ç–∞–≤–∫–∞') || text.includes('–∏—Å–∫—É—Å—Å—Ç–≤–æ')) categories.push('–∏—Å–∫—É—Å—Å—Ç–≤–æ');
    if (text.includes('–ª–µ–∫—Ü–∏—è') || text.includes('–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ')) categories.push('–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ');
    if (text.includes('–∫–∏–Ω–æ') || text.includes('—Ñ–∏–ª—å–º')) categories.push('–∫–∏–Ω–æ');
    if (text.includes('—Ç–µ–∞—Ç—Ä') || text.includes('—Å–ø–µ–∫—Ç–∞–∫–ª—å')) categories.push('—Ç–µ–∞—Ç—Ä');
    if (text.includes('—Å–ø–æ—Ä—Ç')) categories.push('—Å–ø–æ—Ä—Ç');
    
    const eventData = {
        title: title,
        description: messageText.substring(0, 500),
        date: new Date().toISOString().split('T')[0] + ' 19:00', // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–µ–≥–æ–¥–Ω—è –≤ 19:00
        location: location,
        price: price,
        categories: categories.length > 0 ? categories : ['—Å–æ–±—ã—Ç–∏–µ'],
        confidence: 0.6,
        isFree: isFree,
        isOnline: text.includes('–æ–Ω–ª–∞–π–Ω') || text.includes('online')
    };
    
    console.log('‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:', eventData.title);
    return eventData;
}

// Cloud Function –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
exports.parsemessage = functions.https.onCall(async (data, context) => {
    const { messageText, messageLink } = data;
    
    if (!messageText) {
        throw new functions.https.HttpsError('invalid-argument', '–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω');
    }

    let parsedEvent;
    try {
        parsedEvent = await parseTelegramMessage(messageText, messageLink || '');
    } catch (e) {
        console.error('Config or parsing error:', e);
        throw new functions.https.HttpsError('failed-precondition', '–û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ YandexGPT –∏–ª–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞');
    }
    
    if (parsedEvent && parsedEvent.confidence > 0.7) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firestore (–±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö dvizheon)
        await admin.firestore().collection('events').add({
            ...parsedEvent,
            source: 'yandexgpt_parser',
            telegramUrl: messageLink || '',
            createdAt: admin.firestore.FieldValue.serverTimestamp(),
            parsedAt: new Date().toISOString()
        });
        
        return { success: true, event: parsedEvent };
    }
    
    return { success: false, reason: '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ' };
});


// –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–µ–±-—Å–∫—Ä–∞–ø–ø–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ Telegram –∫–∞–Ω–∞–ª–∞
async function scrapeChannelMessages(channelUrl, limit = 20) {
    try {
        console.log(`üîç –ü–∞—Ä—Å–∏–Ω–≥ –≤–µ–±-–≤–µ—Ä—Å–∏–∏ –∫–∞–Ω–∞–ª–∞: ${channelUrl}`);
        
        // –ü–æ–ª—É—á–∞–µ–º HTML —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–∞–Ω–∞–ª–∞
        const response = await axios.get(channelUrl, {
            headers: {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
                'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
                'Accept-Language': 'ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3',
                'Accept-Encoding': 'gzip, deflate, br',
                'Connection': 'keep-alive',
                'Upgrade-Insecure-Requests': '1'
            },
            timeout: 10000
        });
        
        const html = response.data;
        const $ = cheerio.load(html);
        
        const messages = [];
        
        // –ò—â–µ–º –±–ª–æ–∫–∏ —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
        $('.tgme_widget_message').each((index, element) => {
            if (messages.length >= limit) return false;
            
            const $message = $(element);
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
            const textElement = $message.find('.tgme_widget_message_text');
            if (textElement.length === 0) return;
            
            let messageText = textElement.html()
                .replace(/<[^>]*>/g, '') // –£–±–∏—Ä–∞–µ–º HTML —Ç–µ–≥–∏
                .replace(/&quot;/g, '"')
                .replace(/&amp;/g, '&')
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/&nbsp;/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
            
            if (messageText.length < 50) return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–æ—Ä–æ—Ç–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞—Ç—É
            const dateElement = $message.find('time');
            let messageDate = new Date();
            if (dateElement.length > 0) {
                const datetime = dateElement.attr('datetime');
                if (datetime) {
                    messageDate = new Date(datetime);
                }
            }
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –ø–æ—Å—Ç
            let postLink = channelUrl;
            const linkElement = $message.find('a[href*="t.me/"]').first();
            if (linkElement.length > 0) {
                postLink = linkElement.attr('href');
            } else {
                // –°—Ç—Ä–æ–∏–º —Å—Å—ã–ª–∫—É –Ω–∞ –æ—Å–Ω–æ–≤–µ ID —Å–æ–æ–±—â–µ–Ω–∏—è
                const messageId = $message.attr('data-post') || index;
                const channelUsername = channelUrl.match(/t\.me\/s\/([^\/]+)/);
                if (channelUsername) {
                    postLink = `https://t.me/${channelUsername[1]}/${messageId}`;
                }
            }
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —Å—Å—ã–ª–∫–∏
            let messageId = `msg_${index}`;
            const idMatch = postLink.match(/\/(\d+)$/);
            if (idMatch) {
                messageId = idMatch[1];
            }
            
            messages.push({
                messageId: messageId,
                text: messageText,
                date: messageDate,
                link: postLink
            });
        });
        
        console.log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∫–∞–Ω–∞–ª–µ: ${messages.length}`);
        return messages;
        
    } catch (error) {
        console.error(`‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–∞–Ω–∞–ª–∞ ${channelUrl}:`, error.message);
        return [];
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏
function isEventMessage(text) {
    const eventKeywords = [
        '–∫–æ–Ω—Ü–µ—Ä—Ç', '–≤—ã—Å—Ç–∞–≤–∫–∞', '–ª–µ–∫—Ü–∏—è', '–º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å', '—Ñ–µ—Å—Ç–∏–≤–∞–ª—å', '–∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è', 
        '—Å–µ–º–∏–Ω–∞—Ä', '–≤—Å—Ç—Ä–µ—á–∞', '–ø–æ–∫–∞–∑', '–ø—Ä–µ–º—å–µ—Ä–∞', '—Å–ø–µ–∫—Ç–∞–∫–ª—å', '–ø–µ—Ä—Ñ–æ—Ä–º–∞–Ω—Å',
        '–∑–∞–≤—Ç—Ä–∞', '—Å–µ–≥–æ–¥–Ω—è', '—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è', 
        '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è',
        '–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–≤—Ç–æ—Ä–Ω–∏–∫', '—Å—Ä–µ–¥–∞', '—á–µ—Ç–≤–µ—Ä–≥', '–ø—è—Ç–Ω–∏—Ü–∞', '—Å—É–±–±–æ—Ç–∞', '–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ',
        '–±–µ—Å–ø–ª–∞—Ç–Ω–æ', '–≤—Ö–æ–¥ —Å–≤–æ–±–æ–¥–Ω—ã–π', '–±–∏–ª–µ—Ç—ã', '—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è', '–∑–∞–ø–∏—Å—å', '–≤—Ä–µ–º—è:', '–º–µ—Å—Ç–æ:'
    ];
    
    // –ò—Å–∫–ª—é—á–∞–µ–º –æ–±—â–∏–µ —Å–ª–æ–≤–∞
    const excludeWords = [
        '–Ω–æ–≤–æ—Å—Ç–∏', '—Å–æ–±—ã—Ç–∏—è', '–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è', '–∞–Ω–æ–Ω—Å', '–æ–±–∑–æ—Ä', '–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è',
        '–º–æ—Å–∫–æ–≤—Å–∫–∏–µ', '–º–æ—Å–∫–≤—ã', '–≥–æ—Ä–æ–¥–∞', '—Ä–∞–π–æ–Ω–∞', '–æ–±–ª–∞—Å—Ç–∏'
    ];
    
    const lowerText = text.toLowerCase();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏—è
    if (excludeWords.some(word => lowerText.includes(word))) {
        return false;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
    const hasEventKeywords = eventKeywords.some(keyword => lowerText.includes(keyword));
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏
    const hasDateTime = /\d{1,2}\s*(—è–Ω–≤–∞—Ä—è|—Ñ–µ–≤—Ä–∞–ª—è|–º–∞—Ä—Ç–∞|–∞–ø—Ä–µ–ª—è|–º–∞—è|–∏—é–Ω—è|–∏—é–ª—è|–∞–≤–≥—É—Å—Ç–∞|—Å–µ–Ω—Ç—è–±—Ä—è|–æ–∫—Ç—è–±—Ä—è|–Ω–æ—è–±—Ä—è|–¥–µ–∫–∞–±—Ä—è)/i.test(text) ||
                       /\d{1,2}:\d{2}/.test(text) ||
                       /(–∑–∞–≤—Ç—Ä–∞|—Å–µ–≥–æ–¥–Ω—è|–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫|–≤—Ç–æ—Ä–Ω–∏–∫|—Å—Ä–µ–¥–∞|—á–µ—Ç–≤–µ—Ä–≥|–ø—è—Ç–Ω–∏—Ü–∞|—Å—É–±–±–æ—Ç–∞|–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ)/i.test(text);
    
    return hasEventKeywords && hasDateTime;
}

// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞ Telegram –∫–∞–Ω–∞–ª–æ–≤ —á–µ—Ä–µ–∑ –≤–µ–±-—Å–∫—Ä–∞–ø–ø–∏–Ω–≥
async function parseTelegramChannels() {
    console.log('üöÄ –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞ Telegram –∫–∞–Ω–∞–ª–æ–≤...');
    const startTime = Date.now();
    
    try {
        // –ü–æ–ª—É—á–∞–µ–º –∫–∞–Ω–∞–ª—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        console.log('üîç –ò—â–µ–º –∫–∞–Ω–∞–ª—ã –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ channels...');
        let channelsSnapshot = await db.collection('channels').get();
        
        console.log(`üìä –ù–∞–π–¥–µ–Ω–æ ${channelsSnapshot.size} –∫–∞–Ω–∞–ª–æ–≤ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏`);
        
        // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–∞–Ω–∞–ª—ã
        const activeChannels = [];
        channelsSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.enabled === true) {
                activeChannels.push({
                    id: doc.id,
                    ...data
                });
            }
        });
        
        console.log(`‚úÖ –ê–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤: ${activeChannels.length}`);
        
        if (activeChannels.length === 0) {
            console.log('‚ö†Ô∏è –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞, —Å–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–∞–Ω–∞–ª—ã...');
            
            // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–∞–Ω–∞–ª—ã –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
            const testChannels = [
                {
                    name: '–ú–æ—Å–∫–æ–≤—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è',
                    username: 'moscow_events',
                    url: 'https://t.me/moscow_events',
                    category: 'events',
                    enabled: true,
                    lastParsed: 0
                },
                {
                    name: 'IT –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –ú–æ—Å–∫–≤—ã',
                    username: 'it_events_moscow',
                    url: 'https://t.me/it_events_moscow',
                    category: 'it',
                    enabled: true,
                    lastParsed: 0
                }
            ];
            
            const batch = db.batch();
            const channelsCollection = db.collection('channels');
            
            testChannels.forEach(channel => {
                const docRef = channelsCollection.doc();
                batch.set(docRef, {
                    ...channel,
                    createdAt: admin.firestore.FieldValue.serverTimestamp()
                });
            });
            
            await batch.commit();
            console.log(`‚úÖ –°–æ–∑–¥–∞–Ω–æ ${testChannels.length} —Ç–µ—Å—Ç–æ–≤—ã—Ö –∫–∞–Ω–∞–ª–æ–≤`);
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª—ã
            channelsSnapshot = await db.collection('channels')
                .where('enabled', '==', true)
                .get();
        }
        
        const channels = [];
        channelsSnapshot.forEach(doc => {
            const data = doc.data();
            channels.push({
                id: doc.id,
                name: data.name,
                username: data.username,
                url: data.url,
                category: data.category || 'general',
                lastParsed: data.lastParsed || 0
            });
        });
        
        console.log(`üìä –ù–∞–π–¥–µ–Ω–æ ${channels.length} –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞`);
        
        let totalProcessed = 0;
        let totalEvents = 0;
        let totalErrors = 0;
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π –∫–∞–Ω–∞–ª
        for (const channel of channels) {
            try {
                console.log(`üì∫ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–Ω–∞–ª–∞: ${channel.name} (@${channel.username})`);
                
                // –ü—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Bot API, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
                let messages;
                try {
                    messages = await parseTelegramChannelWithBotAPI(channel.username, 10); // –£–º–µ–Ω—å—à–∏–ª –¥–æ 10 –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
                    console.log(`‚úÖ –ü–æ–ª—É—á–µ–Ω–æ ${messages ? messages.length : 0} —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ Bot API –¥–ª—è ${channel.name}`);
                } catch (botError) {
                    console.log(`‚ö†Ô∏è Bot API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è @${channel.username}, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–µ–±-—Å–∫—Ä–∞–ø–ø–∏–Ω–≥`);
                    messages = await scrapeChannelMessages(channel.url, 10); // –£–º–µ–Ω—å—à–∏–ª –¥–æ 10 –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
                    console.log(`üìÑ –ù–∞–π–¥–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ ${channel.name}: ${messages ? messages.length : 0}`);
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ messages –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∏ —è–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º
                if (!messages || !Array.isArray(messages)) {
                    console.log(`‚ùå –û—à–∏–±–∫–∞: messages –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∏–ª–∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º –¥–ª—è –∫–∞–Ω–∞–ª–∞ ${channel.name}`);
                    continue;
                }
                
                console.log(`üìù –ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É ${messages.length} —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–∞–Ω–∞–ª–∞ ${channel.name}`);
                
                for (const message of messages) {
                    // –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∫—ç—à–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è YandexGPT
                    const messageKey = `${channel.username}_${message.messageId}`;
                    console.log(`üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ: ${messageKey}`);
                    
                    // –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è YandexGPT
                    console.log(`üéØ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: ${message.text.substring(0, 100)}...`);
                    
                    try {
                        // –ü–∞—Ä—Å–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ YandexGPT
                        const parsedEvent = await parseTelegramMessage(message.text, message.link);
                        
                        if (parsedEvent) {
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–µ —Å–æ–±—ã—Ç–∏–µ
                            const existingEvent = await db.collection('events')
                                .where('messageId', '==', message.messageId)
                                .where('channelUsername', '==', channel.username)
                                .limit(1)
                                .get();
                            
                            if (existingEvent.empty) {
                                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firestore
                                const eventData = {
                                    title: parsedEvent.title,
                                    description: parsedEvent.description || '',
                                    startAtMillis: parsedEvent.startAtMillis,
                                    isOnline: parsedEvent.isOnline,
                                    isFree: parsedEvent.isFree,
                                    price: parsedEvent.price,
                                    location: parsedEvent.location,
                                    imageUrls: parsedEvent.imageUrls,
                                    categories: parsedEvent.categories,
                                    telegramUrl: message.link,
                                    source: 'yandexgpt_parser',
                                    channelName: channel.name,
                                    channelUsername: channel.username,
                                    channelCategory: channel.category,
                                    messageId: message.messageId,
                                    originalText: message.text,
                                    messageDate: message.date,
                                    confidence: parsedEvent.confidence,
                                    createdAt: admin.firestore.FieldValue.serverTimestamp(),
                                    parsedAt: new Date().toISOString()
                                };
                                
                                await db.collection('events').add(eventData);
                                
                                totalEvents++;
                                console.log(`‚úÖ –°–æ–±—ã—Ç–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ${parsedEvent.title} –∏–∑ @${channel.username}`);
                            } else {
                                console.log(`‚è≠Ô∏è –°–æ–±—ã—Ç–∏–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: ${parsedEvent.title} –∏–∑ @${channel.username}`);
                            }
                        }
                        
                        // –û—Ç–º–µ—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ
                        processedMessages.add(messageKey);
                    } catch (parseError) {
                        console.error(`‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ @${channel.username}:`, parseError.message);
                        totalErrors++;
                    }
                    
                    totalProcessed++;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–∞–Ω–∞–ª–∞
                await db.collection('channels').doc(channel.id).update({
                    lastParsed: admin.firestore.FieldValue.serverTimestamp()
                });
                
            } catch (channelError) {
                console.error(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–∞–Ω–∞–ª–∞ ${channel.name}:`, channelError);
            }
        }
        
        const duration = Date.now() - startTime;
        console.log(`üéâ –ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω –∑–∞ ${duration}ms`);
        console.log(`üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: ${totalProcessed}, –Ω–∞–π–¥–µ–Ω–æ —Å–æ–±—ã—Ç–∏–π: ${totalEvents}, –æ—à–∏–±–æ–∫: ${totalErrors}`);
        
        return {
            success: true,
            processed: totalProcessed,
            events: totalEvents,
            errors: totalErrors,
            duration: duration,
            message: `–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${totalProcessed} —Å–æ–æ–±—â–µ–Ω–∏–π, –Ω–∞–π–¥–µ–Ω–æ ${totalEvents} —Å–æ–±—ã—Ç–∏–π –∑–∞ ${duration}ms`
        };
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ Telegram –∫–∞–Ω–∞–ª–æ–≤:', error);
        return {
            success: false,
            error: error.message
        };
    }
}


// –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –ø–∞—Ä—Å–∏–Ω–≥ Telegram –∫–∞–Ω–∞–ª–æ–≤ (–∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É)
const { onSchedule } = require('firebase-functions/v2/scheduler');

exports.parseTelegramChannels = onSchedule('every 1 minutes', async (event) => {
    console.log('üîÑ –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ Telegram –∫–∞–Ω–∞–ª–æ–≤...');
    return await parseTelegramChannels();
});

// –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞ Telegram –∫–∞–Ω–∞–ª–æ–≤
exports.parseChannelsManual = functions.https.onCall(async (data, context) => {
    return await parseTelegramChannels();
});


// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–ª–ª–µ–∫—Ü–∏–π –∏ –∫–∞–Ω–∞–ª–æ–≤
exports.initializeDatabase = functions.https.onCall(async (data, context) => {
    try {
        console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö dvizheon...');
        
        // –°–æ–∑–¥–∞–µ–º –∫–æ–ª–ª–µ–∫—Ü–∏—é –∫–∞–Ω–∞–ª–æ–≤ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
        const channelsCollection = db.collection('channels');
        const defaultChannels = [
            {
                username: 'moscow_events',
                name: '–ú–æ—Å–∫–æ–≤—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è',
                url: 'https://t.me/s/moscow_events',
                enabled: true,
                lastParsed: null,
                createdAt: admin.firestore.FieldValue.serverTimestamp()
            },
            {
                username: 'art_moscow',
                name: '–ò—Å–∫—É—Å—Å—Ç–≤–æ –ú–æ—Å–∫–≤—ã',
                url: 'https://t.me/s/art_moscow',
                enabled: true,
                lastParsed: null,
                createdAt: admin.firestore.FieldValue.serverTimestamp()
            },
            {
                username: 'music_moscow',
                name: '–ú—É–∑—ã–∫–∞ –ú–æ—Å–∫–≤—ã',
                url: 'https://t.me/s/music_moscow',
                enabled: true,
                lastParsed: null,
                createdAt: admin.firestore.FieldValue.serverTimestamp()
            },
            {
                username: 'sport_moscow',
                name: '–°–ø–æ—Ä—Ç –ú–æ—Å–∫–≤—ã',
                url: 'https://t.me/s/sport_moscow',
                enabled: true,
                lastParsed: null,
                createdAt: admin.firestore.FieldValue.serverTimestamp()
            },
            {
                username: 'education_moscow',
                name: '–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –ú–æ—Å–∫–≤—ã',
                url: 'https://t.me/s/education_moscow',
                enabled: true,
                lastParsed: null,
                createdAt: admin.firestore.FieldValue.serverTimestamp()
            }
        ];
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–Ω–∞–ª—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        const batch = db.batch();
        defaultChannels.forEach(channel => {
            const docRef = channelsCollection.doc();
            batch.set(docRef, channel);
        });
        
        await batch.commit();
        
        console.log(`‚úÖ –°–æ–∑–¥–∞–Ω–æ ${defaultChannels.length} –∫–∞–Ω–∞–ª–æ–≤ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞`);
        
        // –°–æ–∑–¥–∞–µ–º –∫–æ–ª–ª–µ–∫—Ü–∏—é —Å–æ–±—ã—Ç–∏–π —Å —Ç–µ—Å—Ç–æ–≤—ã–º —Å–æ–±—ã—Ç–∏–µ–º
        const eventsCollection = db.collection('events');
        const testEvent = {
            title: '–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ',
            startAtMillis: Date.now(),
            isOnline: false,
            isFree: true,
            price: null,
            location: '–¢–µ—Å—Ç–æ–≤–∞—è –ª–æ–∫–∞—Ü–∏—è',
            imageUrls: [],
            categories: ['—Ç–µ—Å—Ç'],
            telegramUrl: 'https://t.me/test/123',
            createdAt: admin.firestore.FieldValue.serverTimestamp(),
            source: 'manual_test'
        };
        
        await eventsCollection.add(testEvent);
        
        console.log('‚úÖ –°–æ–∑–¥–∞–Ω–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ');
        
        return { 
            success: true, 
            message: '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ',
            channelsCount: defaultChannels.length
        };
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:', error);
        throw new functions.https.HttpsError('internal', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏', error.message);
    }
});

// –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –∑–∞ —Å–µ–Ω—Ç—è–±—Ä—å
exports.createSeptemberEvents = functions.https.onCall(async (data, context) => {
    try {
        console.log('–°–æ–∑–¥–∞–µ–º —Å–æ–±—ã—Ç–∏—è –∑–∞ —Å–µ–Ω—Ç—è–±—Ä—å...');
        
        const events = [
            {
                title: '–§–µ—Å—Ç–∏–≤–∞–ª—å "–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ—Å–µ–Ω—å"',
                startAtMillis: new Date('2024-09-01T18:00:00').getTime(),
                isOnline: false,
                isFree: true,
                price: null,
                location: '–ü–∞—Ä–∫ –°–æ–∫–æ–ª—å–Ω–∏–∫–∏, –≥–ª–∞–≤–Ω–∞—è —Å—Ü–µ–Ω–∞',
                imageUrls: [],
                categories: ['—Ñ–µ—Å—Ç–∏–≤–∞–ª—å', '–º—É–∑—ã–∫–∞'],
                createdAt: admin.firestore.FieldValue.serverTimestamp()
            },
            {
                title: '–í—ã—Å—Ç–∞–≤–∫–∞ "–û—Å–µ–Ω–Ω–∏–µ –∫—Ä–∞—Å–∫–∏"',
                startAtMillis: new Date('2024-09-05T10:00:00').getTime(),
                isOnline: false,
                isFree: false,
                price: 300,
                location: '–¢—Ä–µ—Ç—å—è–∫–æ–≤—Å–∫–∞—è –≥–∞–ª–µ—Ä–µ—è',
                imageUrls: [],
                categories: ['–∏—Å–∫—É—Å—Å—Ç–≤–æ', '–≤—ã—Å—Ç–∞–≤–∫–∞'],
                createdAt: admin.firestore.FieldValue.serverTimestamp()
            },
            {
                title: '–ö–æ–Ω—Ü–µ—Ä—Ç –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–π –º—É–∑—ã–∫–∏',
                startAtMillis: new Date('2024-09-08T19:30:00').getTime(),
                isOnline: false,
                isFree: false,
                price: 800,
                location: '–ö–æ–Ω—Ü–µ—Ä—Ç–Ω—ã–π –∑–∞–ª –∏–º. –ß–∞–π–∫–æ–≤—Å–∫–æ–≥–æ',
                imageUrls: [],
                categories: ['–º—É–∑—ã–∫–∞', '–∫–ª–∞—Å—Å–∏–∫–∞'],
                createdAt: admin.firestore.FieldValue.serverTimestamp()
            },
            {
                title: '–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –∑–∞–±–µ–≥ "–û—Å–µ–Ω–Ω–∏–π –º–∞—Ä–∞—Ñ–æ–Ω"',
                startAtMillis: new Date('2024-09-12T09:00:00').getTime(),
                isOnline: false,
                isFree: true,
                price: null,
                location: '–ü–∞—Ä–∫ –ì–æ—Ä—å–∫–æ–≥–æ',
                imageUrls: [],
                categories: ['—Å–ø–æ—Ä—Ç', '–±–µ–≥'],
                createdAt: admin.firestore.FieldValue.serverTimestamp()
            },
            {
                title: '–õ–µ–∫—Ü–∏—è "–ò—Å—Ç–æ—Ä–∏—è –ú–æ—Å–∫–≤—ã"',
                startAtMillis: new Date('2024-09-15T15:00:00').getTime(),
                isOnline: true,
                isFree: true,
                price: null,
                location: '–û–Ω–ª–∞–π–Ω',
                imageUrls: [],
                categories: ['–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ', '–∏—Å—Ç–æ—Ä–∏—è'],
                createdAt: admin.firestore.FieldValue.serverTimestamp()
            },
            {
                title: '–¢–µ–∞—Ç—Ä–∞–ª—å–Ω–∞—è –ø—Ä–µ–º—å–µ—Ä–∞ "–û—Å–µ–Ω–Ω–∏–µ —Å–Ω—ã"',
                startAtMillis: new Date('2024-09-18T20:00:00').getTime(),
                isOnline: false,
                isFree: false,
                price: 1200,
                location: '–ú–•–¢ –∏–º. –ß–µ—Ö–æ–≤–∞',
                imageUrls: [],
                categories: ['—Ç–µ–∞—Ç—Ä', '–ø—Ä–µ–º—å–µ—Ä–∞'],
                createdAt: admin.firestore.FieldValue.serverTimestamp()
            },
            {
                title: '–§–µ—Å—Ç–∏–≤–∞–ª—å —É–ª–∏—á–Ω–æ–π –µ–¥—ã',
                startAtMillis: new Date('2024-09-22T12:00:00').getTime(),
                isOnline: false,
                isFree: true,
                price: null,
                location: '–ü–∞—Ä–∫ –ö–æ–ª–æ–º–µ–Ω—Å–∫–æ–µ',
                imageUrls: [],
                categories: ['–µ–¥–∞', '—Ñ–µ—Å—Ç–∏–≤–∞–ª—å'],
                createdAt: admin.firestore.FieldValue.serverTimestamp()
            },
            {
                title: '–ö–æ–Ω—Ü–µ—Ä—Ç –¥–∂–∞–∑–æ–≤–æ–π –º—É–∑—ã–∫–∏',
                startAtMillis: new Date('2024-09-25T21:00:00').getTime(),
                isOnline: false,
                isFree: false,
                price: 600,
                location: '–î–∂–∞–∑-–∫–ª—É–± "–°–æ—é–∑ –∫–æ–º–ø–æ–∑–∏—Ç–æ—Ä–æ–≤"',
                imageUrls: [],
                categories: ['–º—É–∑—ã–∫–∞', '–¥–∂–∞–∑'],
                createdAt: admin.firestore.FieldValue.serverTimestamp()
            },
            {
                title: '–ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å –ø–æ –∂–∏–≤–æ–ø–∏—Å–∏',
                startAtMillis: new Date('2024-09-28T14:00:00').getTime(),
                isOnline: false,
                isFree: false,
                price: 500,
                location: '–ê—Ä—Ç-—Å—Ç—É–¥–∏—è "–ü–∞–ª–∏—Ç—Ä–∞"',
                imageUrls: [],
                categories: ['—Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ', '–∂–∏–≤–æ–ø–∏—Å—å'],
                createdAt: admin.firestore.FieldValue.serverTimestamp()
            },
            {
                title: '–ó–∞–∫—Ä—ã—Ç–∏–µ –ª–µ—Ç–Ω–µ–≥–æ —Å–µ–∑–æ–Ω–∞ –≤ –ø–∞—Ä–∫–µ',
                startAtMillis: new Date('2024-09-30T16:00:00').getTime(),
                isOnline: false,
                isFree: true,
                price: null,
                location: '–ü–∞—Ä–∫ –°–æ–∫–æ–ª—å–Ω–∏–∫–∏',
                imageUrls: [],
                categories: ['–ø—Ä–∞–∑–¥–Ω–∏–∫', '–∑–∞–∫—Ä—ã—Ç–∏–µ —Å–µ–∑–æ–Ω–∞'],
                createdAt: admin.firestore.FieldValue.serverTimestamp()
            }
        ];
        
        const batch = db.batch();
        const eventsCollection = db.collection('events');
        
        events.forEach(event => {
            const docRef = eventsCollection.doc();
            batch.set(docRef, event);
        });
        
        await batch.commit();
        
        console.log(`‚úÖ –°–æ–∑–¥–∞–Ω–æ ${events.length} —Å–æ–±—ã—Ç–∏–π –∑–∞ —Å–µ–Ω—Ç—è–±—Ä—å`);
        return { success: true, count: events.length };
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–æ–±—ã—Ç–∏–π –∑–∞ —Å–µ–Ω—Ç—è–±—Ä—å:', error);
        throw new functions.https.HttpsError('internal', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–æ–±—ã—Ç–∏–π', error.message);
    }
});

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
exports.addChannel = functions.https.onCall(async (data, context) => {
    const { username, name } = data;
    
    if (!username || !name) {
        throw new functions.https.HttpsError('invalid-argument', 'username –∏ name –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã');
    }
    
    return await addChannelToMonitoring(username, name);
});

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–∞–Ω–∞–ª–æ–≤
exports.getChannels = functions.https.onCall(async (data, context) => {
    const channels = await getMonitoredChannels();
    return { success: true, channels };
});

// –£–¥–∞–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ –∏–∑ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
exports.removeChannel = functions.https.onCall(async (data, context) => {
    const { channelId } = data;
    
    if (!channelId) {
        throw new functions.https.HttpsError('invalid-argument', 'channelId –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω');
    }
    
    try {
        const channelsRef = admin.firestore().collection('config').doc('telegram_channels');
        const channelsDoc = await channelsRef.get();
        
        if (channelsDoc.exists) {
            const channels = channelsDoc.data().channels || [];
            const updatedChannels = channels.filter(channel => channel.id !== channelId);
            
            await channelsRef.update({ channels: updatedChannels });
            return { success: true };
        }
        
        return { success: false, error: '–ö–∞–Ω–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω' };
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞:', error);
        return { success: false, error: error.message };
    }
});

// Cloud Function –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤—Å–µ—Ö –∫–∞–Ω–∞–ª–æ–≤
exports.parseallchannels = functions.https.onCall(async (data, context) => {
    try {
        console.log('üöÄ –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤—Å–µ—Ö –∫–∞–Ω–∞–ª–æ–≤...');
        const result = await parseTelegramChannels();
        return result;
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–∞–Ω–∞–ª–æ–≤:', error);
        throw new functions.https.HttpsError('internal', '–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–∞–Ω–∞–ª–æ–≤');
    }
});

// v2-–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤—ã—à–µ —á–µ—Ä–µ–∑ onSchedule('every 30 minutes')

// –¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞
exports.clearAllEvents = functions.https.onCall(async (data, context) => {
    try {
        console.log('–ù–∞—á–∏–Ω–∞—é –æ—á–∏—Å—Ç–∫—É –≤—Å–µ—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π...');
        
        // Get all events
        const eventsSnapshot = await admin.firestore().collection('events').get();
        console.log(`–ù–∞–π–¥–µ–Ω–æ ${eventsSnapshot.size} –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è`);
        
        if (eventsSnapshot.size === 0) {
            return { success: true, message: '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', deletedCount: 0 };
        }
        
        // Delete all events in batches
        const batchSize = 500;
        let deletedCount = 0;
        
        for (let i = 0; i < eventsSnapshot.docs.length; i += batchSize) {
            const batch = admin.firestore().batch();
            const batchDocs = eventsSnapshot.docs.slice(i, i + batchSize);
            
            batchDocs.forEach(doc => {
                batch.delete(doc.ref);
            });
            
            await batch.commit();
            deletedCount += batchDocs.length;
            console.log(`–£–¥–∞–ª–µ–Ω–æ ${deletedCount}/${eventsSnapshot.size} –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π`);
        }
        
        console.log(`‚úÖ –£—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ ${deletedCount} –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π`);
        return { success: true, message: `–£–¥–∞–ª–µ–Ω–æ ${deletedCount} –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π`, deletedCount };
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π:', error);
        return { success: false, error: error.message };
    }
});

exports.testChannelParsing = functions.https.onCall(async (data, context) => {
    const { channelUrl, channelUsername } = data;
    
    if (!channelUrl) {
        throw new functions.https.HttpsError('invalid-argument', 'channelUrl –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω');
    }
    
    try {
        console.log(`üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–∞—Ä—Å–∏–Ω–≥ –∫–∞–Ω–∞–ª–∞: ${channelUrl}`);
        
        // –ü–∞—Ä—Å–∏–º –∫–∞–Ω–∞–ª
        const messages = await scrapeChannelMessages(channelUrl, 5);
        console.log(`üì® –ù–∞–π–¥–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: ${messages.length}`);
        
        const results = [];
        
        for (const message of messages) {
            console.log(`üìù –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ: ${message.text.substring(0, 100)}...`);
            console.log(`üîó –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ—Å—Ç: ${message.link}`);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏
            if (isEventMessage(message.text)) {
                console.log(`‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏ –Ω–∞–π–¥–µ–Ω–æ!`);
                
                // –ü–∞—Ä—Å–∏–º —á–µ—Ä–µ–∑ YandexGPT
                const parsedEvent = await parseTelegramMessage(message.text, message.link);
                
                if (parsedEvent) {
                    results.push({
                        messageId: message.messageId,
                        text: message.text,
                        link: message.link,
                        parsedEvent: parsedEvent,
                        success: true
                    });
                } else {
                    results.push({
                        messageId: message.messageId,
                        text: message.text,
                        link: message.link,
                        parsedEvent: null,
                        success: false,
                        reason: '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ'
                    });
                }
            } else {
                console.log(`‚ùå –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏`);
                results.push({
                    messageId: message.messageId,
                    text: message.text,
                    link: message.link,
                    parsedEvent: null,
                    success: false,
                    reason: '–ù–µ —è–≤–ª—è–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏'
                });
            }
        }
        
        return {
            success: true,
            channelUrl: channelUrl,
            channelUsername: channelUsername,
            messagesFound: messages.length,
            results: results
        };
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞:', error);
        throw new functions.https.HttpsError('internal', '–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞', error.message);
    }
});

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
exports.addTestChannels = functions.https.onCall(async (data, context) => {
    console.log('–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–æ–≤ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞...');

    try {
        const channels = [
            {
                name: '–ù–∞ –§–∞–Ω–µ—Ä–µ',
                username: 'Na_Fanere',
                url: 'https://t.me/s/Na_Fanere',
                category: 'events',
                enabled: true,
                lastParsed: 0
            },
            {
                name: '–ì–∞–∑–µ—Ç–∞ "–°—Ç–æ–ª–∏—Ü–∞"',
                username: 'gzsmsk',
                url: 'https://t.me/s/gzsmsk',
                category: 'events',
                enabled: true,
                lastParsed: 0
            },
            {
                name: '–ú–æ—Å–∫–æ–≤—Å–∫–∏–π –≥—É–ª—è–∫–∞',
                username: 'mosgul',
                url: 'https://t.me/s/mosgul',
                category: 'events',
                enabled: true,
                lastParsed: 0
            },
            {
                name: '–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è',
                username: 'freeskidos',
                url: 'https://t.me/s/freeskidos',
                category: 'events',
                enabled: true,
                lastParsed: 0
            },
            {
                name: '–ù–æ—è–±—Ä—å—Å–∫–∏–π –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä',
                username: 'novembercinema',
                url: 'https://t.me/s/novembercinema',
                category: 'events',
                enabled: true,
                lastParsed: 0
            },
            {
                name: '–ú–û–°–ö–í–ò–ß —ä | –î–û–°–£–ì | –ú–æ—Å–∫–≤–∞ | –ê–§–ò–®–ê | –°–û–ë–´–¢–ò–Ø | –ë–ï–°–ü–õ–ê–¢–ù–û',
                username: 'NovostiMoskvbl',
                url: 'https://t.me/s/NovostiMoskvbl',
                category: 'events',
                enabled: true,
                lastParsed: 0
            },
            {
                name: '–¢–æ–ª—å–∫–æ –ø–∞—Ä–∫',
                username: 'only_park',
                url: 'https://t.me/s/only_park',
                category: 'events',
                enabled: true,
                lastParsed: 0
            }
        ];

        const batch = db.batch();
        const channelsCollection = db.collection('channels');

        channels.forEach(channel => {
            const docRef = channelsCollection.doc();
            batch.set(docRef, {
                ...channel,
                createdAt: admin.firestore.FieldValue.serverTimestamp()
            });
        });

        await batch.commit();

        console.log(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ ${channels.length} –∫–∞–Ω–∞–ª–æ–≤`);
        return { success: true, count: channels.length, message: '–ö–∞–Ω–∞–ª—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã' };

    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–∞–Ω–∞–ª–æ–≤:', error);
        return { success: false, error: error.message };
    }
});

exports.checkChannels = functions.https.onCall(async (data, context) => {
    console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–Ω–∞–ª–æ–≤ –≤ Firestore...');

    try {
        const channelsSnapshot = await db.collection('channels').get();
        
        if (channelsSnapshot.empty) {
            console.log('‚ö†Ô∏è –ö–æ–ª–ª–µ–∫—Ü–∏—è channels –ø—É—Å—Ç–∞—è');
            return { success: true, count: 0, message: '–ö–æ–ª–ª–µ–∫—Ü–∏—è channels –ø—É—Å—Ç–∞—è' };
        }

        const channels = [];
        channelsSnapshot.forEach(doc => {
            const data = doc.data();
            channels.push({
                id: doc.id,
                name: data.name,
                username: data.username,
                enabled: data.enabled,
                category: data.category
            });
        });

        console.log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ ${channels.length} –∫–∞–Ω–∞–ª–æ–≤:`, channels);
        return { success: true, count: channels.length, channels: channels };

    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–∞–Ω–∞–ª–æ–≤:', error);
        return { success: false, error: error.message };
    }
});

// –ü—Ä–æ—Å—Ç–∞—è —Ç–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firestore
exports.testFirestore = functions.https.onCall(async (data, context) => {
    console.log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firestore...');

    try {
        // –ü—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Å—Ç–æ–π –¥–æ–∫—É–º–µ–Ω—Ç
        await db.collection('test').doc('connection-test').set({
            timestamp: admin.firestore.FieldValue.serverTimestamp(),
            message: 'Test connection successful'
        });
        
        console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Firestore —É—Å–ø–µ—à–Ω–æ');
        
        // –£–¥–∞–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç
        await db.collection('test').doc('connection-test').delete();
        
        return { 
            success: true, 
            message: 'Firestore connection successful' 
        };

    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firestore:', error);
        return { 
            success: false, 
            error: error.message,
            code: error.code,
            details: error.details
        };
    }
});

// –¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ YandexGPT
exports.testYandexGPT = functions.https.onCall(async (data, context) => {
    const testMessage = "–ö–æ–Ω—Ü–µ—Ä—Ç –≥—Ä—É–ø–ø—ã 'Radiohead' 20 —Å–µ–Ω—Ç—è–±—Ä—è –≤ 19:00 –≤ –∫–ª—É–±–µ '–¶–∏—Ñ–µ—Ä–±–ª–∞—Ç'. –í—Ö–æ–¥ 500 —Ä—É–±–ª–µ–π.";
    
    try {
        const result = await parseTelegramMessageWithSDK(testMessage, 'https://t.me/test');
        return { success: true, result: result };
    } catch (error) {
        return { success: false, error: error.message };
    }
});
